<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Venue Demographics - 30A Florida</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0D0D0D;
      color: #FFFFFF;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid #333;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .header p {
      color: #888;
      font-size: 14px;
    }
    
    .status {
      display: inline-block;
      padding: 4px 12px;
      background: #10B981;
      color: white;
      border-radius: 20px;
      font-size: 12px;
      margin-top: 10px;
    }
    
    .status.error {
      background: #EF4444;
    }
    
    .status.loading {
      background: #F59E0B;
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 400px;
      height: calc(100vh - 120px);
    }
    
    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
        height: auto;
      }
    }
    
    #map {
      width: 100%;
      height: 100%;
      min-height: 400px;
      background: #1a1a1a;
    }
    
    .sidebar {
      background: #1a1a1a;
      padding: 20px;
      overflow-y: auto;
      border-left: 1px solid #333;
    }
    
    .section {
      margin-bottom: 24px;
    }
    
    .section h2 {
      font-size: 16px;
      color: #6366F1;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .venue-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .venue-card {
      background: #252525;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    
    .venue-card:hover {
      background: #2a2a2a;
      border-color: #6366F1;
    }
    
    .venue-card.active {
      border-color: #6366F1;
      background: #2a2a3a;
    }
    
    .venue-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .venue-meta {
      font-size: 12px;
      color: #888;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .category-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      text-transform: uppercase;
      color: white;
    }
    
    .category-bar { background: #7C3AED; }
    .category-restaurant { background: #F59E0B; }
    .category-cafe { background: #10B981; }
    .category-brewery { background: #EF4444; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .stat-card {
      background: #252525;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #6366F1;
    }
    
    .stat-label {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }
    
    .api-section {
      background: #252525;
      padding: 12px;
      border-radius: 8px;
    }
    
    .api-url {
      font-family: monospace;
      font-size: 11px;
      color: #10B981;
      word-break: break-all;
      margin-bottom: 8px;
    }
    
    .api-response {
      background: #1a1a1a;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
      max-height: 150px;
      overflow-y: auto;
      color: #888;
      white-space: pre-wrap;
    }
    
    .privacy-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #1a2a1a;
      border: 1px solid #10B981;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
    }
    
    .privacy-badge span {
      color: #10B981;
      font-size: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }
    
    .leaflet-popup-content-wrapper {
      background: #1a1a1a;
      color: white;
      border-radius: 8px;
    }
    
    .leaflet-popup-tip {
      background: #1a1a1a;
    }
    
    .popup-content h3 {
      margin-bottom: 8px;
      color: white;
    }
    
    .popup-content p {
      font-size: 12px;
      color: #ccc;
      margin: 4px 0;
    }
    
    .location-badge {
      background: #3B82F6;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üèñÔ∏è Venue Demographics <span class="location-badge">30A Florida</span></h1>
    <p>Privacy-first crowd demographics for bars & restaurants</p>
    <div id="apiStatus" class="status loading">Connecting...</div>
  </div>
  
  <div class="container">
    <div id="map"></div>
    
    <div class="sidebar">
      <div class="section">
        <div class="privacy-badge">
          <span>üîí</span>
          <div>
            <strong>Privacy Mode Active</strong><br>
            <small>K-anonymity: 10+ visitors required</small>
          </div>
        </div>
      </div>
      
      <div class="section">
        <h2>üìä API Stats</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="venueCount">-</div>
            <div class="stat-label">Venues</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="categoryCount">-</div>
            <div class="stat-label">Categories</div>
          </div>
        </div>
      </div>
      
      <div class="section">
        <h2>üìç Nearby Venues</h2>
        <div id="venueList" class="venue-list">
          <div class="loading">Loading venues...</div>
        </div>
      </div>
      
      <div class="section">
        <h2>üîå Live API</h2>
        <div class="api-section">
          <div class="api-url" id="currentApi">GET /v1/health</div>
          <div class="api-response" id="apiResponse">Connecting to API...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API_BASE = 'https://venue-demographics-api-production.up.railway.app/v1';
    
    // 30A Florida - Seaside area
    const CENTER = [30.3205, -86.1435];
    
    // Global variables
    let map;
    let markers = [];
    let venues = [];
    
    // Category colors
    const categoryColors = {
      bar: '#7C3AED',
      restaurant: '#F59E0B',
      cafe: '#10B981',
      brewery: '#EF4444'
    };
    
    // Initialize map
    function initMap() {
      map = L.map('map').setView(CENTER, 12);
      
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap ¬© CARTO',
        maxZoom: 19
      }).addTo(map);
    }
    
    // Check API health
    async function checkHealth() {
      try {
        const res = await fetch(API_BASE + '/health');
        const data = await res.json();
        
        document.getElementById('apiStatus').textContent = 
          data.status === 'healthy' ? '‚úì API Connected' : 'API Error';
        document.getElementById('apiStatus').className = 
          data.status === 'healthy' ? 'status' : 'status error';
        
        updateApiDisplay('/health', data);
        return true;
      } catch (err) {
        document.getElementById('apiStatus').textContent = '‚úó API Offline';
        document.getElementById('apiStatus').className = 'status error';
        updateApiDisplay('/health', { error: err.message });
        return false;
      }
    }
    
    // Load venues
    async function loadVenues() {
      try {
        // Use larger radius for 30A (venues spread along coast)
        const url = API_BASE + '/venues/nearby?lat=' + CENTER[0] + '&lng=' + CENTER[1] + '&radius=10000';
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success && data.data && data.data.venues) {
          venues = data.data.venues;
          displayVenues(venues);
          updateApiDisplay('/venues/nearby?lat=30.32&lng=-86.14&radius=10000', data);
          
          // Update stats
          document.getElementById('venueCount').textContent = venues.length;
          const categories = [];
          venues.forEach(function(v) {
            if (categories.indexOf(v.category) === -1) {
              categories.push(v.category);
            }
          });
          document.getElementById('categoryCount').textContent = categories.length;
        } else {
          document.getElementById('venueList').innerHTML = 
            '<div class="loading">No venues found in this area.<br><small>Add 30A venues to your database!</small></div>';
        }
      } catch (err) {
        document.getElementById('venueList').innerHTML = 
          '<div class="loading">Failed to load venues: ' + err.message + '</div>';
      }
    }
    
    // Display venues on map and list
    function displayVenues(venueList) {
      // Clear existing markers
      markers.forEach(function(m) { map.removeLayer(m); });
      markers = [];
      
      // Add markers
      venueList.forEach(function(venue, index) {
        const color = categoryColors[venue.category] || '#6366F1';
        
        const icon = L.divIcon({
          className: 'custom-marker',
          html: '<div style="background:' + color + ';width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });
        
        const marker = L.marker([venue.latitude, venue.longitude], { icon: icon })
          .addTo(map)
          .bindPopup(
            '<div class="popup-content">' +
            '<h3>' + venue.name + '</h3>' +
            '<p><strong>Category:</strong> ' + venue.category + '</p>' +
            '<p><strong>Address:</strong> ' + (venue.address || 'N/A') + '</p>' +
            '<p><strong>Distance:</strong> ' + (venue.distance / 1000).toFixed(1) + ' km</p>' +
            '</div>'
          );
        
        (function(idx) {
          marker.on('click', function() { selectVenue(idx); });
        })(index);
        
        markers.push(marker);
      });
      
      // Update list
      let listHtml = '';
      venueList.forEach(function(venue, index) {
        const distanceKm = (venue.distance / 1000).toFixed(1);
        listHtml += '<div class="venue-card" onclick="selectVenue(' + index + ')" id="venue-' + index + '">' +
          '<div class="venue-name">' + venue.name + '</div>' +
          '<div class="venue-meta">' +
          '<span class="category-badge category-' + venue.category + '">' + venue.category + '</span>' +
          '<span>' + distanceKm + ' km away</span>' +
          '</div></div>';
      });
      
      document.getElementById('venueList').innerHTML = listHtml || '<div class="loading">No venues found</div>';
      
      // Fit map to show all markers if we have any
      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }
    
    // Select a venue
    function selectVenue(index) {
      // Update active state
      const cards = document.querySelectorAll('.venue-card');
      for (let i = 0; i < cards.length; i++) {
        cards[i].classList.remove('active');
      }
      document.getElementById('venue-' + index).classList.add('active');
      
      // Open popup and center map
      const venue = venues[index];
      map.setView([venue.latitude, venue.longitude], 15);
      markers[index].openPopup();
      
      // Show venue in API display
      updateApiDisplay('/venues/' + venue.id.substring(0, 8) + '...', venue);
    }
    
    // Update API display
    function updateApiDisplay(endpoint, data) {
      document.getElementById('currentApi').textContent = 'GET ' + endpoint;
      document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
    }
    
    // Make selectVenue global
    window.selectVenue = selectVenue;
    
    // Initialize everything when page loads
    window.onload = function() {
      initMap();
      checkHealth().then(function() {
        loadVenues();
      });
    };
  </script>
</body>
</html>
